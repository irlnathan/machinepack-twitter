module.exports = {


  friendlyName: 'Get access token',


  description: 'Generate a new access token for acting on behalf of a particular Twitter user account.',


  extendedDescription: 'This machine should be used from your Twitter callback route (i.e. Twitter will redirect the user back to the `callbackUrl` you specify along with two values: "oauth_token" and "oauth_verifier".  These two values can then be passed to this machine in order to get the access token which authorizes your app to access this user\'s Twitter account.)',


  moreInfoUrl: 'https://dev.twitter.com/web/sign-in/implementing',


  inputs: {

    consumerKey: {
      example: 'xAmBxAmBxAmBkjbyKkjbyKkjbyK',
      description: 'The `consumerKey` associated with one of your Twitter developer apps.',
      required: true,
      whereToGet: {
        url: 'http://dev.twitter.com/apps',
        description: 'Copy and paste an API key, or create one if you haven\'t already.',
        extendedDescription: 'If you don\'t have any Twitter apps created yet, you\'ll need to make one first.'
      }
    },

    consumerSecret: {
      example: 'xAmBxAmBxAmBkjbyKkjbyKkjbyK',
      description: 'The `consumerSecret` associated with one of your Twitter developer apps.',
      required: true,
      whereToGet: {
        url: 'http://dev.twitter.com/apps',
        description: 'Copy and paste an API key, or create one if you haven\'t already.',
        extendedDescription: 'If you don\'t have any Twitter apps created yet, you\'ll need to make one first.'
      }
    },

    oauthToken: {
      example: 'UL1866Vlkl0aZyPw2Kd2u592D17Xl1uE',
      description: 'The token generated by Twitter and provided to the callbackUrl as "oauth_token".',
      extendedDescription: 'This is generated by Twitter and passed as a parameter when redirecting users to the callbackUrl you specified- but only if the user chooses to grant your app the requested permissions.',
      whereToGet: {
        url: 'https://g.twimg.com/dev/sites/default/files/images_documentation/sign-in-flow3-3legged.png',
        description: 'Grab the value of the parameter, e.g. req.param(\'oauth_token\')'
      },
      required: true
    },

    oauthVerifier: {
      example: 'xEj5XxGFWe6vPiJFofYgVMZjw6eVc6Mw',
      description: 'The verification code generated by Twitter and provided to the callbackUrl as "oauth_verifier".',
      extendedDescription: 'This is generated by Twitter and passed as a parameter when redirecting users to the callbackUrl you specified- but only if the user chooses to grant your app the requested permissions.',
      whereToGet: {
        url: 'https://g.twimg.com/dev/sites/default/files/images_documentation/sign-in-flow3-3legged.png',
        description: 'Grab the value of the parameter, e.g. req.param(\'oauth_verifier\')'
      },
      required: true
    }

  },


  defaultExit: 'success',


  exits: {

    error: {
      description: 'Unexpected error occurred.'
    },

    success: {
      description: 'Returns the user\'s permanent tokens, id, and screen name.',
      example: {
        accessToken: '847489329-998DSdafaasdDSF08asdfda08agf6ad6fsdaa08dasdaf76sa5',
        accessSecret: 'SDFSssdfsdf9&SDfSDFSDFSfd9877ssdf',
        screenName: 'johngalt',
        userId: '54952598'
      }
    }

  },


  fn: function(inputs, exits) {

    var request = require('request');
    var qs = require('querystring');

    request.post({
      url: 'https://api.twitter.com/oauth/access_token',
      oauth: {
        consumer_key: inputs.consumerKey,
        consumer_secret: inputs.consumerSecret,
        token: inputs.oauthToken,
        verifier: inputs.oauthVerifier
      }
    }, function(err, response, body) {
      if (err) {
        return exits.error(err);
      }
      if (response.statusCode > 299 || response.statusCode < 200) {
        return exits.error(response.statusCode);
      }


      var parsedResponse;
      try {
        // oauth_token=3493938-B34829ABLD2NASI242AAGa32&oauth_token_secret=42Ga2gj249gADg9031jgasdGanv2139mmadval14aD&user_id=3493938&screen_name=mikermcneil
        parsedResponse = qs.parse(body);
      }
      catch (e) { return exits.error(e); }

      return exits.success({
        userId: parsedResponse.user_id,
        screenName: parsedResponse.screen_name,
        accessToken: parsedResponse.oauth_token,
        accessSecret: parsedResponse.oauth_token_secret
      });

    });
  }


};
